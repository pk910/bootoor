{{ define "page" }}
  <div class="container mt-2">
    <h3 class="py-2">Bootnode Overview</h3>

    <!-- ENR Header Section -->
    {{ if .LocalENR }}
    <div class="card mt-3">
      <div class="card-body">
        <h5 class="card-title">Bootnode ENR</h5>
        <p class="text-muted mb-3">Share this Ethereum Node Record (ENR) with peers to allow them to discover and connect to this bootnode.</p>
        <div class="input-group">
          <input type="text" class="form-control font-monospace" value="{{ .LocalENR }}" readonly>
          <button class="btn btn-outline-secondary" type="button" data-clipboard-text="{{ .LocalENR }}" data-bs-toggle="tooltip" title="Copy ENR to clipboard">
            <i class="fa fa-copy"></i>
          </button>
        </div>
      </div>
    </div>
    {{ end }}

    <!-- Enode Section -->
    {{ if .LocalEnode }}
    <div class="card mt-3">
      <div class="card-body">
        <h5 class="card-title">Bootnode Enode</h5>
        <p class="text-muted mb-3">Enode URL derived from ENR for Execution Layer (EL) nodes.</p>
        <div class="input-group">
          <input type="text" class="form-control font-monospace" value="{{ .LocalEnode }}" readonly>
          <button class="btn btn-outline-secondary" type="button" data-clipboard-text="{{ .LocalEnode }}" data-bs-toggle="tooltip" title="Copy Enode to clipboard">
            <i class="fa fa-copy"></i>
          </button>
        </div>
      </div>
    </div>
    {{ end }}

    <!-- Peer ID Section -->
    <div class="card mt-3">
      <div class="card-body">
        <h5 class="card-title">Peer ID</h5>
        <div class="input-group">
          <input type="text" class="form-control font-monospace" value="{{ .PeerID }}" readonly>
          <button class="btn btn-outline-secondary" type="button" data-clipboard-text="{{ .PeerID }}" data-bs-toggle="tooltip" title="Copy Peer ID to clipboard">
            <i class="fa fa-copy"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Stats Cards Grid -->
    <div class="row mt-3">
      <!-- Node Status Card -->
      <div class="col-12 col-md-6 col-lg-4 mb-3">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="card-title">Node Status</h6>
            <table class="table table-sm mb-0">
              <tbody>
                <tr>
                  <td class="text-muted">Status</td>
                  <td class="text-end"><span class="badge rounded-pill text-bg-success" data-stat="status">{{ .Status }}</span></td>
                </tr>
                {{ if .NetworkName }}
                <tr>
                  <td class="text-muted">Network</td>
                  <td class="text-end"><strong data-stat="network">{{ .NetworkName }}</strong></td>
                </tr>
                {{ end }}
                <tr>
                  <td class="text-muted">Uptime</td>
                  <td class="text-end" data-stat="uptime">{{ formatTimeDiff .StartTime }}</td>
                </tr>
                <tr>
                  <td class="text-muted">Bind Address</td>
                  <td class="text-end"><code style="font-size: 0.85em;" data-stat="bind-address">{{ .BindAddress }}</code></td>
                </tr>
                {{ if .LocalENR }}
                <tr>
                  <td class="text-muted">
                    ENR Seq
                    <i class="fa fa-info-circle text-muted"
                       style="font-size: 0.8em;"
                       role="button"
                       data-bs-toggle="popover"
                       data-bs-trigger="hover focus"
                       data-bs-placement="right"
                       data-bs-html="true"
                       data-bs-title="ENR Sequence Number"
                       data-bs-content="The sequence number of this node's Ethereum Node Record (ENR). This number increments each time the ENR is updated with new information."></i>
                  </td>
                  <td class="text-end"><span class="badge rounded-pill text-bg-info" data-stat="enr-seq">{{ .LocalENRSeq }}</span></td>
                </tr>
                {{ end }}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- EL Routing Table Card -->
      <div class="col-12 col-md-6 col-lg-4 mb-3">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="card-title">
              Execution Layer (EL) Nodes
              <a href="/el-nodes" class="btn btn-sm btn-outline-primary float-end" style="padding: 0.1rem 0.4rem; font-size: 0.75rem;">View</a>
            </h6>
            <table class="table table-sm mb-0">
              <tbody>
                <tr>
                  <td class="text-muted">Total Nodes</td>
                  <td class="text-end"><span class="badge rounded-pill text-bg-primary fs-6" data-stat="el-total-nodes">{{ .ELTotalNodes }}</span></td>
                </tr>
                <tr>
                  <td class="text-muted">
                    Active Nodes
                    <i class="fa fa-info-circle text-muted"
                       style="font-size: 0.8em;"
                       role="button"
                       data-bs-toggle="popover"
                       data-bs-trigger="hover focus"
                       data-bs-placement="right"
                       data-bs-html="true"
                       data-bs-title="Active EL Nodes"
                       data-bs-content="Execution Layer nodes actively monitored and shared with clients. These nodes are pinged regularly and rotated periodically based on performance scores."></i>
                  </td>
                  <td class="text-end"><span class="badge rounded-pill text-bg-success fs-6" data-stat="el-active-nodes">{{ .ELActiveNodes }}</span></td>
                </tr>
                <tr>
                  <td class="text-muted">
                    Inactive Nodes
                    <i class="fa fa-info-circle text-muted"
                       style="font-size: 0.8em;"
                       role="button"
                       data-bs-toggle="popover"
                       data-bs-trigger="hover focus"
                       data-bs-placement="right"
                       data-bs-html="true"
                       data-bs-title="Inactive EL Nodes"
                       data-bs-content="EL nodes stored in the database but not actively monitored. These nodes are periodically rotated into the active pool."></i>
                  </td>
                  <td class="text-end"><span class="badge rounded-pill text-bg-secondary fs-6" data-stat="el-inactive-nodes">{{ .ELTableStats.InactiveNodes }}</span></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- CL Routing Table Card -->
      <div class="col-12 col-md-6 col-lg-4 mb-3">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="card-title">
              Consensus Layer (CL) Nodes
              <a href="/cl-nodes" class="btn btn-sm btn-outline-primary float-end" style="padding: 0.1rem 0.4rem; font-size: 0.75rem;">View</a>
            </h6>
            <table class="table table-sm mb-0">
              <tbody>
                <tr>
                  <td class="text-muted">Total Nodes</td>
                  <td class="text-end"><span class="badge rounded-pill text-bg-primary fs-6" data-stat="cl-total-nodes">{{ .CLTotalNodes }}</span></td>
                </tr>
                <tr>
                  <td class="text-muted">
                    Active Nodes
                    <i class="fa fa-info-circle text-muted"
                       style="font-size: 0.8em;"
                       role="button"
                       data-bs-toggle="popover"
                       data-bs-trigger="hover focus"
                       data-bs-placement="right"
                       data-bs-html="true"
                       data-bs-title="Active CL Nodes"
                       data-bs-content="Consensus Layer nodes actively monitored and shared with clients. These nodes are pinged regularly and rotated periodically based on performance scores."></i>
                  </td>
                  <td class="text-end"><span class="badge rounded-pill text-bg-success fs-6" data-stat="cl-active-nodes">{{ .CLActiveNodes }}</span></td>
                </tr>
                <tr>
                  <td class="text-muted">
                    Inactive Nodes
                    <i class="fa fa-info-circle text-muted"
                       style="font-size: 0.8em;"
                       role="button"
                       data-bs-toggle="popover"
                       data-bs-trigger="hover focus"
                       data-bs-placement="right"
                       data-bs-html="true"
                       data-bs-title="Inactive CL Nodes"
                       data-bs-content="CL nodes stored in the database but not actively monitored. These nodes are periodically rotated into the active pool."></i>
                  </td>
                  <td class="text-end"><span class="badge rounded-pill text-bg-secondary fs-6" data-stat="cl-inactive-nodes">{{ .CLTableStats.InactiveNodes }}</span></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Discovery Stats Card -->
      <div class="col-12 col-md-6 col-lg-4 mb-3">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="card-title">Discovery</h6>
            <table class="table table-sm mb-0">
              <tbody>
                <tr>
                  <td class="text-muted">Lookups Started</td>
                  <td class="text-end" data-stat="lookups-started">{{ .LookupsStarted }}</td>
                </tr>
                <tr>
                  <td class="text-muted">Lookups Completed</td>
                  <td class="text-end" data-stat="lookups-completed">{{ .LookupsCompleted }}</td>
                </tr>
                <tr>
                  <td class="text-muted">Lookups Failed</td>
                  <td class="text-end" data-stat="lookups-failed">{{ .LookupsFailed }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Ping Stats Card -->
      <div class="col-12 col-md-6 col-lg-4 mb-3">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="card-title">Ping Statistics</h6>
            <table class="table table-sm mb-0">
              <tbody>
                <tr>
                  <td class="text-muted">Pings Sent</td>
                  <td class="text-end" data-stat="pings-sent">{{ .PingsSent }}</td>
                </tr>
                <tr>
                  <td class="text-muted">Pongs Received</td>
                  <td class="text-end" data-stat="pongs-received">{{ .PongsReceived }}</td>
                </tr>
                <tr>
                  <td class="text-muted">Success Rate</td>
                  <td class="text-end"><span class="badge rounded-pill text-bg-success" data-stat="ping-success-rate">{{ printf "%.1f" .PingSuccessRate }}%</span></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Sessions & Protocol Card -->
      <div class="col-12 col-md-6 col-lg-4 mb-3">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="card-title">Sessions & Protocol</h6>
            <table class="table table-sm mb-0">
              <tbody>
                <tr>
                  <td class="text-muted">
                    Active Sessions
                    <i class="fa fa-info-circle text-muted"
                       style="font-size: 0.8em;"
                       role="button"
                       data-bs-toggle="popover"
                       data-bs-trigger="hover focus"
                       data-bs-placement="right"
                       data-bs-html="true"
                       data-bs-title="Active Sessions"
                       data-bs-content="Number of currently active encrypted sessions with peer nodes. Each session has established encryption keys and can send/receive encrypted messages."></i>
                  </td>
                  <td class="text-end"><span class="badge rounded-pill text-bg-success fs-6" data-stat="sessions-active">{{ .SessionsActive }}</span></td>
                </tr>
                <tr>
                  <td class="text-muted">Total Sessions</td>
                  <td class="text-end" data-stat="sessions-total">{{ .SessionsTotal }}</td>
                </tr>
                <tr>
                  <td class="text-muted">
                    Pending Handshakes
                    <i class="fa fa-info-circle text-muted"
                       style="font-size: 0.8em;"
                       role="button"
                       data-bs-toggle="popover"
                       data-bs-trigger="hover focus"
                       data-bs-placement="right"
                       data-bs-html="true"
                       data-bs-title="Pending Handshakes"
                       data-bs-content="Messages waiting for handshake completion. After receiving a WHOAREYOU challenge, the node performs a handshake to establish session keys before sending the actual message."></i>
                  </td>
                  <td class="text-end"><span class="badge rounded-pill text-bg-warning" data-stat="pending-handshakes">{{ .PendingHandshakes }}</span></td>
                </tr>
                <tr>
                  <td class="text-muted">
                    Pending Challenges
                    <i class="fa fa-info-circle text-muted"
                       style="font-size: 0.8em;"
                       role="button"
                       data-bs-toggle="popover"
                       data-bs-trigger="hover focus"
                       data-bs-placement="right"
                       data-bs-html="true"
                       data-bs-title="Pending Challenges"
                       data-bs-content="WHOAREYOU challenges sent to peers waiting for handshake responses. These challenges initiate the cryptographic handshake process to establish encrypted sessions."></i>
                  </td>
                  <td class="text-end"><span class="badge rounded-pill text-bg-info" data-stat="pending-challenges">{{ .PendingChallenges }}</span></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Packet Stats Card -->
      <div class="col-12 col-md-6 col-lg-4 mb-3">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="card-title">Packet Statistics</h6>
            <table class="table table-sm mb-0">
              <tbody>
                <tr>
                  <td class="text-muted">Packets Received</td>
                  <td class="text-end" data-stat="packets-received">{{ .PacketsReceived }}</td>
                </tr>
                <tr>
                  <td class="text-muted">Packets Sent</td>
                  <td class="text-end" data-stat="packets-sent">{{ .PacketsSent }}</td>
                </tr>
                <tr>
                  <td class="text-muted">FINDNODE Received</td>
                  <td class="text-end" data-stat="findnode-received">{{ .FindNodeReceived }}</td>
                </tr>
                <tr>
                  <td class="text-muted">Invalid Packets</td>
                  <td class="text-end"><span class="badge rounded-pill text-bg-danger" data-stat="invalid-packets">{{ .InvalidPackets }}</span></td>
                </tr>
                <tr>
                  <td class="text-muted">Filtered Responses</td>
                  <td class="text-end"><span class="badge rounded-pill text-bg-warning" data-stat="filtered-responses">{{ .FilteredResponses }}</span></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Database Stats Card -->
      <div class="col-12 col-md-6 col-lg-4 mb-3">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="card-title">Database & Queue</h6>
            <table class="table table-sm mb-0">
              <tbody>
                <tr>
                  <td class="text-muted">
                    Queue Size
                    <i class="fa fa-info-circle text-muted"
                       style="font-size: 0.8em;"
                       role="button"
                       data-bs-toggle="popover"
                       data-bs-trigger="hover focus"
                       data-bs-placement="right"
                       data-bs-html="true"
                       data-bs-title="Pending Updates"
                       data-bs-content="Number of pending node updates waiting to be written to the database. Updates are batched for efficiency."></i>
                  </td>
                  <td class="text-end"><span class="badge rounded-pill text-bg-info" data-stat="db-queue-size">{{ .DBQueueSize }}</span></td>
                </tr>
                <tr>
                  <td class="text-muted">Processed Updates</td>
                  <td class="text-end" data-stat="db-processed-updates">{{ .DBProcessedUpdates }}</td>
                </tr>
                <tr>
                  <td class="text-muted">
                    Merged Updates
                    <i class="fa fa-info-circle text-muted"
                       style="font-size: 0.8em;"
                       role="button"
                       data-bs-toggle="popover"
                       data-bs-trigger="hover focus"
                       data-bs-placement="right"
                       data-bs-html="true"
                       data-bs-title="Merged Updates"
                       data-bs-content="Number of updates that were merged with existing pending updates for the same node to reduce database writes."></i>
                  </td>
                  <td class="text-end" data-stat="db-merged-updates">{{ .DBMergedUpdates }}</td>
                </tr>
                <tr>
                  <td class="text-muted">Transactions</td>
                  <td class="text-end" data-stat="db-transactions">{{ .DBTransactions }}</td>
                </tr>
                <tr>
                  <td class="text-muted">Total Queries</td>
                  <td class="text-end" data-stat="db-total-queries">{{ .DBTotalQueries }}</td>
                </tr>
                <tr>
                  <td class="text-muted">Open Connections</td>
                  <td class="text-end" data-stat="db-open-connections">{{ .DBOpenConnections }}</td>
                </tr>
                {{ if gt .DBFailedUpdates 0 }}
                <tr>
                  <td class="text-muted">Failed Updates</td>
                  <td class="text-end"><span class="badge rounded-pill text-bg-danger" data-stat="db-failed-updates">{{ .DBFailedUpdates }}</span></td>
                </tr>
                {{ end }}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Fork Info Card -->
      {{ if .CurrentDigest }}
      <div class="col-12 col-md-6 col-lg-4 mb-3">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="card-title">CL Fork Info</h6>
            <table class="table table-sm mb-0">
              <tbody>
                <tr>
                  <td class="text-muted">Current Fork</td>
                  <td class="text-end" data-stat="current-fork">{{ .CurrentFork }}</td>
                </tr>
                <tr>
                  <td class="text-muted">Current Digest</td>
                  <td class="text-end">
                    <code style="font-size: 0.85em;">{{ .CurrentDigest }}</code>
                    <i class="fa fa-copy text-muted ms-1" style="font-size: 0.9em;" role="button" data-bs-toggle="tooltip" title="Copy to clipboard" data-clipboard-text="{{ .CurrentDigest }}"></i>
                  </td>
                </tr>
                {{ if .PreviousDigest }}
                <tr>
                  <td class="text-muted">
                    Previous Digest
                    <i class="fa fa-info-circle text-muted"
                       style="font-size: 0.8em;"
                       role="button"
                       data-bs-toggle="popover"
                       data-bs-trigger="hover focus"
                       data-bs-placement="right"
                       data-bs-html="true"
                       data-bs-title="Previous Fork"
                       data-bs-content="Fork: <strong>{{ .PreviousFork }}</strong><br>This was the active fork before the current one."></i>
                  </td>
                  <td class="text-end">
                    <code style="font-size: 0.85em;" data-stat="previous-digest">{{ .PreviousDigest }}</code>
                    <i class="fa fa-copy text-muted ms-1" style="font-size: 0.9em;" role="button" data-bs-toggle="tooltip" title="Copy to clipboard" data-clipboard-text="{{ .PreviousDigest }}"></i>
                  </td>
                </tr>
                {{ end }}
                {{ if .GenesisDigest }}
                <tr>
                  <td class="text-muted">Genesis Digest</td>
                  <td class="text-end">
                    <code style="font-size: 0.85em;" data-stat="genesis-digest">{{ .GenesisDigest }}</code>
                    <i class="fa fa-copy text-muted ms-1" style="font-size: 0.9em;" role="button" data-bs-toggle="tooltip" title="Copy to clipboard" data-clipboard-text="{{ .GenesisDigest }}"></i>
                  </td>
                </tr>
                {{ end }}
                <tr>
                  <td class="text-muted">Grace Period</td>
                  <td class="text-end" data-stat="grace-period">{{ .GracePeriod }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {{ end }}

      <!-- Fork Filter Stats Card -->
      {{ if .FilterTotalChecks }}
      <div class="col-12 col-md-6 col-lg-4 mb-3">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="card-title">Fork Filter</h6>
            <table class="table table-sm mb-0">
              <tbody>
                <tr>
                  <td class="text-muted">Total Checks</td>
                  <td class="text-end" data-stat="filter-total-checks">{{ .FilterTotalChecks }}</td>
                </tr>
                <tr>
                  <td class="text-muted">Accepted (Current)</td>
                  <td class="text-end"><span class="badge rounded-pill text-bg-success" data-stat="filter-accepted-current">{{ .FilterAcceptedCurrent }}</span></td>
                </tr>
                <tr>
                  <td class="text-muted">Accepted (Old)</td>
                  <td class="text-end"><span class="badge rounded-pill text-bg-warning" data-stat="filter-accepted-old">{{ .FilterAcceptedOld }}</span></td>
                </tr>
                <tr>
                  <td class="text-muted">Rejected (Invalid)</td>
                  <td class="text-end"><span class="badge rounded-pill text-bg-danger" data-stat="filter-rejected-invalid">{{ .FilterRejectedInvalid }}</span></td>
                </tr>
                <tr>
                  <td class="text-muted">Rejected (Expired)</td>
                  <td class="text-end"><span class="badge rounded-pill text-bg-secondary" data-stat="filter-rejected-expired">{{ .FilterRejectedExpired }}</span></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {{ end }}
    </div>

    <!-- Fork Lists Row -->
    {{ if or .ELForks .CLForks }}
    <div class="row mt-3">
      <!-- EL Forks Card -->
      {{ if .ELForks }}
      <div class="col-12 col-lg-6 mb-3">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="card-title">Execution Layer (EL) Forks</h6>
            <div class="table-responsive">
              <table class="table table-sm mb-0">
                <thead>
                  <tr>
                    <th class="text-muted" style="font-weight: 500; font-size: 0.8em;">Fork</th>
                    <th class="text-muted" style="font-weight: 500; font-size: 0.8em;">Activation</th>
                    <th class="text-muted text-end" style="font-weight: 500; font-size: 0.8em;">Digest</th>
                  </tr>
                </thead>
                <tbody>
                  {{ range .ELForks }}
                  <tr>
                    <td>{{ .Name }}</td>
                    <td><code style="font-size: 0.75em;">{{ .Activation }}</code></td>
                    <td class="text-end">
                      <code style="font-size: 0.75em;">{{ .Digest }}</code>
                      <i class="fa fa-copy text-muted ms-1" style="font-size: 0.85em;" role="button" data-bs-toggle="tooltip" title="Copy to clipboard" data-clipboard-text="{{ .Digest }}"></i>
                    </td>
                  </tr>
                  {{ end }}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      {{ end }}

      <!-- CL Forks Card -->
      {{ if .CLForks }}
      <div class="col-12 col-lg-6 mb-3">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="card-title">Consensus Layer (CL) Forks</h6>
            <div class="table-responsive">
              <table class="table table-sm mb-0">
                <thead>
                  <tr>
                    <th class="text-muted" style="font-weight: 500; font-size: 0.8em;">Fork</th>
                    <th class="text-muted" style="font-weight: 500; font-size: 0.8em;">Epoch</th>
                    <th class="text-muted text-end" style="font-weight: 500; font-size: 0.8em;">Digest</th>
                  </tr>
                </thead>
                <tbody>
                  {{ range .CLForks }}
                  <tr>
                    <td>{{ .Name }}</td>
                    <td><code style="font-size: 0.75em;">{{ .Activation }}</code></td>
                    <td class="text-end">
                      <code style="font-size: 0.75em;">{{ .Digest }}</code>
                      <i class="fa fa-copy text-muted ms-1" style="font-size: 0.85em;" role="button" data-bs-toggle="tooltip" title="Copy to clipboard" data-clipboard-text="{{ .Digest }}"></i>
                    </td>
                  </tr>
                  {{ end }}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      {{ end }}
    </div>
    {{ end }}

    <!-- Old Fork Digests Table (if present) -->
    {{ if .OldDigests }}
    <div class="card mt-3 mb-4">
      <div class="card-body">
        <h6 class="card-title">Old Fork Digests (Grace Period)</h6>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Fork Digest</th>
                <th>Remaining Time</th>
              </tr>
            </thead>
            <tbody>
              {{ range $digest := .OldDigests }}
              <tr>
                <td><code>{{ $digest.Digest }}</code></td>
                <td>{{ $digest.Remaining.Round 1000000000 }}</td>
              </tr>
              {{ end }}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {{ end }}
  </div>
{{ end }}

{{ define "js" }}
<script>
  /* Initialize Bootstrap popovers */
  document.addEventListener('DOMContentLoaded', function() {
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    var popoverList = popoverTriggerList.map(function(popoverTriggerEl) {
      return new bootstrap.Popover(popoverTriggerEl);
    });

    /* Handle copy button/icon clicks */
    document.querySelectorAll('[data-clipboard-text]').forEach(function(element) {
      element.addEventListener('click', function() {
        var text = this.getAttribute('data-clipboard-text');
        navigator.clipboard.writeText(text).then(function() {
          /* Update tooltip to show success */
          var tooltip = bootstrap.Tooltip.getInstance(element);
          if (!tooltip) {
            tooltip = new bootstrap.Tooltip(element);
          }
          var originalTitle = element.getAttribute('data-bs-original-title') || element.getAttribute('title');
          element.setAttribute('data-bs-original-title', 'Copied!');
          tooltip.show();
          setTimeout(function() {
            element.setAttribute('data-bs-original-title', originalTitle);
            tooltip.hide();
          }, 2000);
        });
      });
    });

    /* Start auto-update */
    startAutoUpdate();
  });

  function formatTimeDiff(startTime) {
    var now = new Date();
    var start = new Date(startTime);
    var diff = Math.floor((now - start) / 1000); /* seconds */

    var days = Math.floor(diff / 86400);
    var hours = Math.floor((diff % 86400) / 3600);
    var minutes = Math.floor((diff % 3600) / 60);
    var seconds = diff % 60;

    var parts = [];
    if (days > 0) parts.push(days + 'd');
    if (hours > 0) parts.push(hours + 'h');
    if (minutes > 0) parts.push(minutes + 'm');
    if (seconds > 0 || parts.length === 0) parts.push(seconds + 's');

    return parts.join(' ');
  }

  function updateValue(selector, value) {
    var element = document.querySelector(selector);
    if (element && element.textContent !== value) {
      element.textContent = value;
    }
  }

  function updateOverviewData() {
    fetch('/?ajax=1')
      .then(function(response) {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
      })
      .then(function(data) {
        /* Update all dynamic values */
        updateValue('[data-stat="status"]', data.Status);
        if (data.NetworkName) updateValue('[data-stat="network"]', data.NetworkName);
        updateValue('[data-stat="uptime"]', formatTimeDiff(data.StartTime));
        updateValue('[data-stat="bind-address"]', data.BindAddress);
        if (data.LocalENRSeq) updateValue('[data-stat="enr-seq"]', data.LocalENRSeq);

        /* Routing table (combined) */
        updateValue('[data-stat="table-size"]', data.TableSize);
        updateValue('[data-stat="active-nodes"]', data.ActiveNodes);
        updateValue('[data-stat="inactive-nodes"]', data.InactiveNodes);

        /* EL table stats */
        updateValue('[data-stat="el-total-nodes"]', data.ELTotalNodes);
        updateValue('[data-stat="el-active-nodes"]', data.ELActiveNodes);
        if (data.ELTableStats) {
          updateValue('[data-stat="el-inactive-nodes"]', data.ELTableStats.InactiveNodes);
        }

        /* CL table stats */
        updateValue('[data-stat="cl-total-nodes"]', data.CLTotalNodes);
        updateValue('[data-stat="cl-active-nodes"]', data.CLActiveNodes);
        if (data.CLTableStats) {
          updateValue('[data-stat="cl-inactive-nodes"]', data.CLTableStats.InactiveNodes);
        }

        /* Discovery stats */
        updateValue('[data-stat="lookups-started"]', data.LookupsStarted);
        updateValue('[data-stat="lookups-completed"]', data.LookupsCompleted);
        updateValue('[data-stat="lookups-failed"]', data.LookupsFailed);

        /* Ping stats */
        updateValue('[data-stat="pings-sent"]', data.PingsSent);
        updateValue('[data-stat="pongs-received"]', data.PongsReceived);
        updateValue('[data-stat="ping-success-rate"]', data.PingSuccessRate.toFixed(1) + '%');

        /* Session & Protocol stats */
        updateValue('[data-stat="sessions-active"]', data.SessionsActive);
        updateValue('[data-stat="sessions-total"]', data.SessionsTotal);
        updateValue('[data-stat="pending-handshakes"]', data.PendingHandshakes);
        updateValue('[data-stat="pending-challenges"]', data.PendingChallenges);

        /* Database stats */
        updateValue('[data-stat="db-queue-size"]', data.DBQueueSize);
        updateValue('[data-stat="db-processed-updates"]', data.DBProcessedUpdates);
        updateValue('[data-stat="db-merged-updates"]', data.DBMergedUpdates);
        updateValue('[data-stat="db-transactions"]', data.DBTransactions);
        updateValue('[data-stat="db-total-queries"]', data.DBTotalQueries);
        updateValue('[data-stat="db-open-connections"]', data.DBOpenConnections);
        if (data.DBFailedUpdates > 0) {
          updateValue('[data-stat="db-failed-updates"]', data.DBFailedUpdates);
        }

        /* Packet stats */
        updateValue('[data-stat="packets-received"]', data.PacketsReceived);
        updateValue('[data-stat="packets-sent"]', data.PacketsSent);
        updateValue('[data-stat="findnode-received"]', data.FindNodeReceived);
        updateValue('[data-stat="invalid-packets"]', data.InvalidPackets);
        updateValue('[data-stat="filtered-responses"]', data.FilteredResponses);

        /* Fork info (if present) */
        if (data.CurrentFork) updateValue('[data-stat="current-fork"]', data.CurrentFork);
        if (data.GracePeriod) updateValue('[data-stat="grace-period"]', data.GracePeriod);

        /* Fork filter stats (if present) */
        if (data.FilterTotalChecks) {
          updateValue('[data-stat="filter-total-checks"]', data.FilterTotalChecks);
          updateValue('[data-stat="filter-accepted-current"]', data.FilterAcceptedCurrent);
          updateValue('[data-stat="filter-accepted-old"]', data.FilterAcceptedOld);
          updateValue('[data-stat="filter-rejected-invalid"]', data.FilterRejectedInvalid);
          updateValue('[data-stat="filter-rejected-expired"]', data.FilterRejectedExpired);
        }
      })
      .catch(function(error) {
        console.error('Error fetching overview data:', error);
      });
  }

  function startAutoUpdate() {
    /* Update every 10 seconds */
    setInterval(updateOverviewData, 10000);
  }
</script>
{{ end }}

{{ define "css" }}
<style>
  /* Ensure equal height for all stat cards */
  .stats-card {
    height: 100%;
  }

  /* Make the input groups look better - light mode */
  .input-group .form-control {
    background-color: var(--bs-secondary-bg);
    border-color: var(--bs-border-color);
    color: var(--bs-body-color);
  }

  /* Dark mode adjustments */
  [data-bs-theme="dark"] .input-group .form-control {
    background-color: var(--bs-tertiary-bg);
    border-color: var(--bs-border-color);
  }

  /* Improve table styling in cards */
  .card-body .table {
    margin-top: 0.5rem;
  }

  .card-body .table td {
    padding: 0.4rem 0.5rem;
    border: none;
    vertical-align: middle;
  }

  .card-body .table tbody tr:not(:last-child) td {
    border-bottom: 1px solid var(--bs-border-color-translucent);
  }

  /* Make labels slightly smaller and muted */
  .card-body .table td.text-muted {
    font-size: 0.9em;
    width: 50%;
  }

  /* Align values to the right */
  .card-body .table td.text-end {
    font-weight: 500;
  }
</style>
{{ end }}
